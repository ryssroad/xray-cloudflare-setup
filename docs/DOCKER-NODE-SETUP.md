# ะะฐัััะพะนะบะฐ ะฝะพะดั ะฒ Docker ั Cloudflare Origin Certificate

## ะััะธัะตะบัััะฐ Remnawave Panel + Node

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     ะะฐะฝะตะปั ัะฟัะฐะฒะปะตะฝะธั                       โ
โ              (remnawave-panel / marzban)                    โ
โ                                                             โ
โ  - ะะตะฑ-ะธะฝัะตััะตะนั                                            โ
โ  - ะะฐะทะฐ ะดะฐะฝะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน                                โ
โ  - ะะตะฝะตัะฐัะธั ะบะพะฝัะธะณะพะฒ                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                       โ
                       โ API (ะฟะพัั 2222)
                       โ ะะตัะตะดะฐะตั:
                       โ - ะะพะฝัะธะณ Xray
                       โ - ะกะฟะธัะพะบ ะฟะพะปัะทะพะฒะฐัะตะปะตะน (clients)
                       โ - ะะพะผะฐะฝะดั ัะฟัะฐะฒะปะตะฝะธั
                       โ
โโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ะะพะดะฐ (Docker)                            โ
โ                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ          Xray ะฒ ะบะพะฝัะตะนะฝะตัะต                           โ   โ
โ  โ                                                      โ   โ
โ  โ  - ะัะธะฝะธะผะฐะตั ะบะพะฝัะธะณ ะพั ะฟะฐะฝะตะปะธ                        โ   โ
โ  โ  - ะะฑัะฐะฑะฐััะฒะฐะตั ะบะปะธะตะฝััะบะธะต ะฟะพะดะบะปััะตะฝะธั               โ   โ
โ  โ  - ะัะถะฝั TLS ัะตััะธัะธะบะฐัั!                            โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                             โ
โ  Volumes:                                                   โ
โ  - /etc/xray/certs โ /etc/xray/certs (ะผะฐะฟะฟะธะฝะณ ัะตััะพะฒ!)      โ
โ  - /var/lib/remnanode/xray โ /usr/local/bin/xray            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ะัะพะฑะปะตะผะฐ: ะกะตััะธัะธะบะฐัั ะฒ Docker

### ะกะธััะฐัะธั:
- Xray ัะฐะฑะพัะฐะตั **ะฒะฝัััะธ Docker ะบะพะฝัะตะนะฝะตัะฐ**
- ะะพะฝัะธะณ ัะพะทะดะฐะตััั ะฒ ะฟะฐะฝะตะปะธ ะธ ะฟะตัะตะดะฐะตััั ะฒ ะบะพะฝัะตะนะฝะตั
- **ะกะตััะธัะธะบะฐัั ะฝะฐัะพะดัััั ะฝะฐ ัะพััะต** (ะฒะฝะต ะบะพะฝัะตะนะฝะตัะฐ)
- Xray ะฒะฝัััะธ ะบะพะฝัะตะนะฝะตัะฐ ะฝะต ะฒะธะดะธั ัะตััะธัะธะบะฐัั ะฝะฐ ัะพััะต โ

### ะะตัะตะฝะธะต:
1. **Volume mapping** - ะฟัะพะฑัะพัะธัั ัะตััะธัะธะบะฐัั ั ัะพััะฐ ะฒ ะบะพะฝัะตะนะฝะตั
2. **Cloudflare Origin Certificate** - ะพะดะธะฝ wildcard ัะตััะธัะธะบะฐั ะดะปั ะฒัะตั ััะฑะดะพะผะตะฝะพะฒ
3. **ะัะฐะฒะธะปัะฝัะต ะฟััะธ** ะฒ ะบะพะฝัะธะณะต (ะฟััะธ ะะะฃะขะะ ะบะพะฝัะตะนะฝะตัะฐ)

---

## โจ Cloudflare Origin Certificate (ะะะะะะะะะฃะะขะกะฏ!)

### ะัะตะธะผััะตััะฒะฐ:

โ **Wildcard ัะตััะธัะธะบะฐั**
- `*.myfly.space` - ัะฐะฑะพัะฐะตั ะดะปั ะะกะะฅ ััะฑะดะพะผะตะฝะพะฒ
- `cdn.myfly.space` โ
- `cdn2.myfly.space` โ
- `cdn3.myfly.space` โ
- `api.myfly.space` โ

โ **ะะพะปะณะธะน ััะพะบ ะดะตะนััะฒะธั**
- ะะตะนััะฒัะตั **15 ะปะตั**
- ะะต ะฝัะถะฝะพ ะพะฑะฝะพะฒะปััั ะบะฐะถะดัะต 90 ะดะฝะตะน (ะบะฐะบ Let's Encrypt)
- ะฃััะฐะฝะพะฒะธะป ะธ ะทะฐะฑัะป!

โ **ะะดะธะฝ ัะตััะธัะธะบะฐั ะฝะฐ ะะกะ ะฝะพะดั**
- ะะฐะทะฒะตัััะฒะฐะตัะต ะฝะพะฒัั ะฝะพะดั? ะะพะฟะธััะตัะต ัะพั ะถะต ัะตััะธัะธะบะฐั!
- ะะต ะฝัะถะฝะพ ะฟะพะปััะฐัั ะฝะพะฒัะน ัะตััะธัะธะบะฐั ะดะปั ะบะฐะถะดะพะณะพ ััะฑะดะพะผะตะฝะฐ
- ะฃะฟัะพัะฐะตั ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธะต

โ **ะะตะทะพะฟะฐัะฝะพััั**
- ะะฐะฑะพัะฐะตั ะขะะะฌะะ ั Cloudflare CDN
- ะัะปะธ ะบัะพ-ัะพ ัะบัะฐะดะตั ัะตััะธัะธะบะฐั, ะฝะต ัะผะพะถะตั ะธัะฟะพะปัะทะพะฒะฐัั (ะฝัะถะตะฝ Cloudflare proxy)
- ะะฐะปะธะดะธััะตััั ัะพะปัะบะพ ะผะตะถะดั Cloudflare โ ะะฐั ัะตัะฒะตั

โ **ะะตะดะพััะฐัะพะบ:**
- ะะฐะฑะพัะฐะตั ะขะะะฌะะ ัะตัะตะท Cloudflare Proxy (ะพัะฐะฝะถะตะฒะพะต ะพะฑะปะฐะบะพ)
- ะะปั Reality (ะฟััะผะพะต ะฟะพะดะบะปััะตะฝะธะต) ะฝัะถะตะฝ Let's Encrypt

---

## ๐ ะจะฐะณ 1: ะะพะปััะตะฝะธะต Cloudflare Origin Certificate

### 1.1. ะกะพะทะดะฐะฝะธะต ัะตััะธัะธะบะฐัะฐ ะฒ Cloudflare

1. **ะัะบัะพะนัะต Cloudflare Dashboard**
2. ะัะฑะตัะธัะต ะฒะฐั ะดะพะผะตะฝ: `myfly.space`
3. **SSL/TLS โ Origin Server**
4. ะะฐะถะผะธัะต **"Create Certificate"**

**ะะฐัััะพะนะบะธ:**

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Create Origin Certificate                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                         โ
โ Generate private key and CSR with Cloudflare            โ
โ โ Let Cloudflare generate a private key and CSR         โ
โ   โ Use my private key and CSR                          โ
โ                                                         โ
โ Private Key Type:                                       โ
โ   RSA (2048) โผ                                          โ
โ                                                         โ
โ Hostnames:                                              โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ   โ *.myfly.space                                    โ  โ โ WILDCARD!
โ   โ myfly.space                                      โ  โ โ Root domain
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                         โ
โ Certificate Validity:                                   โ
โ   15 years โผ                                            โ โ ะะฐะบัะธะผัะผ!
โ                                                         โ
โ         [ Create ]                                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ะะะะะ:**
- ะฃะบะฐะถะธัะต ะพะฑะฐ: `*.myfly.space` ะ `myfly.space`
- ะัะฑะตัะธัะต 15 years

5. **ะะฐะถะผะธัะต "Create"**

### 1.2. ะกะพััะฐะฝะตะฝะธะต ัะตััะธัะธะบะฐัะฐ

Cloudflare ะฟะพะบะฐะถะตั **ะดะฒะฐ ัะตะบััะพะฒัั ะฑะปะพะบะฐ:**

**Origin Certificate (ะฟัะฑะปะธัะฝัะน ะบะปัั):**
```
-----BEGIN CERTIFICATE-----
MIIEpDCCAowCCQC...
(ะผะฝะพะณะพ ัััะพะบ)
...8X4Zw==
-----END CERTIFICATE-----
```

**Private Key (ะฟัะธะฒะฐัะฝัะน ะบะปัั):**
```
-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgk...
(ะผะฝะพะณะพ ัััะพะบ)
...gECAwEAAQ==
-----END PRIVATE KEY-----
```

โ๏ธ **ะะะะะ:** Private Key ะฟะพะบะฐะทัะฒะฐะตััั **ะขะะะฌะะ ะะะะ ะะะ**!
- ะกะบะพะฟะธััะนัะต ะธ ัะพััะฐะฝะธัะต ะะะ ะฑะปะพะบะฐ
- ะัะปะธ ะฟะพัะตััะตัะต, ะฟัะธะดะตััั ัะพะทะดะฐะฒะฐัั ะฝะพะฒัะน ัะตััะธัะธะบะฐั

---

## ๐ ะจะฐะณ 2: ะฃััะฐะฝะพะฒะบะฐ ัะตััะธัะธะบะฐัะฐ ะฝะฐ ัะตัะฒะตั

### 2.1. ะกะพะทะดะฐะนัะต ะดะธัะตะบัะพัะธั ะดะปั ัะตััะธัะธะบะฐัะพะฒ

```bash
# ะะฐ ัะพััะต (ะะ ะฒ Docker!)
mkdir -p /etc/xray/certs
cd /etc/xray/certs
```

### 2.2. ะกะพััะฐะฝะธัะต ัะตััะธัะธะบะฐั

```bash
# ะกะพะทะดะฐะนัะต ัะฐะนะป ะดะปั ัะตััะธัะธะบะฐัะฐ
nano /etc/xray/certs/cloudflare-origin.pem
```

**ะััะฐะฒััะต "Origin Certificate" ะธะท Cloudflare:**
```
-----BEGIN CERTIFICATE-----
MIIEpDCCAowCCQC...
...
-----END CERTIFICATE-----
```

**ะกะพััะฐะฝะธัะต:** `Ctrl+O`, `Enter`, `Ctrl+X`

### 2.3. ะกะพััะฐะฝะธัะต ะฟัะธะฒะฐัะฝัะน ะบะปัั

```bash
# ะกะพะทะดะฐะนัะต ัะฐะนะป ะดะปั ะบะปััะฐ
nano /etc/xray/certs/cloudflare-origin-key.pem
```

**ะััะฐะฒััะต "Private Key" ะธะท Cloudflare:**
```
-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgk...
...
-----END PRIVATE KEY-----
```

**ะกะพััะฐะฝะธัะต:** `Ctrl+O`, `Enter`, `Ctrl+X`

### 2.4. ะฃััะฐะฝะพะฒะธัะต ะฟัะฐะฒะธะปัะฝัะต ะฟัะฐะฒะฐ ะดะพัััะฟะฐ

```bash
# ะะปะฐะดะตะปะตั: root (ะธะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะบะพัะพััะน ะทะฐะฟััะบะฐะตั Docker)
chown root:root /etc/xray/certs/*.pem

# ะัะฐะฒะฐ:
chmod 644 /etc/xray/certs/cloudflare-origin.pem      # ะัะฑะปะธัะฝัะน - ัะธัะฐัั ะผะพะถะฝะพ
chmod 600 /etc/xray/certs/cloudflare-origin-key.pem  # ะัะธะฒะฐัะฝัะน - ัะพะปัะบะพ root!

# ะัะพะฒะตัััะต
ls -la /etc/xray/certs/
```

**ะะพะปะถะฝะพ ะฑััั:**
```
-rw-r--r-- 1 root root 1234 Nov 10 15:00 cloudflare-origin.pem
-rw------- 1 root root 5678 Nov 10 15:00 cloudflare-origin-key.pem
```

---

## ๐ ะจะฐะณ 3: ะะฑะฝะพะฒะปะตะฝะธะต docker-compose.yaml

### 3.1. ะะพะฑะฐะฒััะต volume ะดะปั ัะตััะธัะธะบะฐัะพะฒ

```yaml
services:
  remnanode:
    container_name: remnanode
    hostname: remnanode
    image: remnawave/node:latest
    env_file:
      - .env
    network_mode: host
    restart: always
    volumes:
      # ะกััะตััะฒัััะธะต volumes
      - /var/lib/remnanode/xray:/usr/local/bin/xray
      - /var/lib/remnanode/geoip.dat:/usr/local/share/xray/geoip.dat
      - /var/lib/remnanode/geosite.dat:/usr/local/share/xray/geosite.dat

      # ะะะะะะฌะขะ: ะะฐะฟะฟะธะฝะณ ัะตััะธัะธะบะฐัะพะฒ
      - /etc/xray/certs:/etc/xray/certs:ro
      #  โ                โ                โ
      #  ะััั ะฝะฐ ัะพััะต   ะััั ะฒ ะบะพะฝัะตะนะฝะตัะต  read-only
```

**ะงัะพ ััะพ ะทะฝะฐัะธั:**
- `/etc/xray/certs` (ัะพัั) โ `/etc/xray/certs` (ะบะพะฝัะตะนะฝะตั)
- `:ro` = read-only (ะบะพะฝัะตะนะฝะตั ะฝะต ะผะพะถะตั ะธะทะผะตะฝะธัั ัะฐะนะปั, ัะพะปัะบะพ ัะธัะฐัั)
- ะขะตะฟะตัั Xray ะฒ ะบะพะฝัะตะนะฝะตัะต ะฒะธะดะธั ัะตััะธัะธะบะฐัั!

### 3.2. ะะตัะตัะพะทะดะฐะนัะต ะบะพะฝัะตะนะฝะตั

```bash
cd /root/xray-cloudflare-setup/docker

# ะััะฐะฝะพะฒะธัะต ัะตะบััะธะน ะบะพะฝัะตะนะฝะตั
docker-compose down

# ะะฐะฟัััะธัะต ั ะฝะพะฒัะผะธ volumes
docker-compose up -d

# ะัะพะฒะตัััะต ััะพ ะบะพะฝัะตะนะฝะตั ะทะฐะฟัััะธะปัั
docker ps

# ะัะพะฒะตัััะต ะปะพะณะธ
docker logs remnanode -f
```

### 3.3. ะัะพะฒะตัััะต ััะพ ัะตััะธัะธะบะฐัั ะฒะธะดะฝั ะฒ ะบะพะฝัะตะนะฝะตัะต

```bash
# ะะฐะนะดะธัะต ะฒ ะบะพะฝัะตะนะฝะตั
docker exec -it remnanode sh

# ะัะพะฒะตัััะต ััะพ ัะฐะนะปั ะตััั
ls -la /etc/xray/certs/

# ะะพะปะถะฝั ะฒะธะดะตัั:
# cloudflare-origin.pem
# cloudflare-origin-key.pem

# ะัะนะดะธัะต
exit
```

โ **ะัะปะธ ะฒะธะดะธัะต ัะฐะนะปั - ะพัะปะธัะฝะพ! ะะฐะฟะฟะธะฝะณ ัะฐะฑะพัะฐะตั.**

---

## ๐ ะจะฐะณ 4: ะะพะฝัะธะณััะฐัะธั ะฒ ะฟะฐะฝะตะปะธ

### 4.1. ะััะธ ะบ ัะตััะธัะธะบะฐัะฐะผ ะ ะะะะคะะะ

**ะะะะะ:** ะ ะบะพะฝัะธะณะต ัะบะฐะทัะฒะฐะตะผ ะฟััะธ **ะะะฃะขะะ ะบะพะฝัะตะนะฝะตัะฐ**, ะฐ ะฝะต ะฝะฐ ัะพััะต!

```json
{
  "inbounds": [{
    "tag": "TM-CDN-WS-IN",
    "port": 443,
    "protocol": "vless",
    "settings": {
      "clients": []
    },
    "streamSettings": {
      "network": "ws",
      "security": "tls",
      "tlsSettings": {
        "certificates": [{
          "certificateFile": "/etc/xray/certs/cloudflare-origin.pem",     // โ ะััั ะ ะะะะขะะะะะะ!
          "keyFile": "/etc/xray/certs/cloudflare-origin-key.pem"          // โ ะััั ะ ะะะะขะะะะะะ!
        }]
      },
      "wsSettings": {
        "path": "/ws-path",
        "headers": {
          "Host": "cdn.myfly.space"   // โ ะัะฑะพะน ััะฑะดะพะผะตะฝ ัะฐะฑะพัะฐะตั!
        }
      }
    }
  }]
}
```

### 4.2. ะะพะฑะฐะฒะปะตะฝะธะต ะบะพะฝัะธะณะฐ ะฒ ะฟะฐะฝะตะปั

**ะงะตัะตะท ะฒะตะฑ-ะธะฝัะตััะตะนั Remnawave/Marzban:**

1. ะัะบัะพะนัะต ะฟะฐะฝะตะปั
2. **Settings โ Xray Configuration** (ะธะปะธ Nodes โ Edit Node Config)
3. ะะฐะนะดะธัะต ะผะฐััะธะฒ `inbounds`
4. ะะพะฑะฐะฒััะต ะฝะพะฒัะน inbound ะธะท ะฟัะธะผะตัะฐ ะฒััะต
5. **Save & Restart**

**ะะฐะฝะตะปั ะฐะฒัะพะผะฐัะธัะตัะบะธ:**
- ะัะฟัะฐะฒะธั ะบะพะฝัะธะณ ะฝะฐ ะฝะพะดั ัะตัะตะท ะฟะพัั 2222
- ะะพะดะฐ ะพะฑะฝะพะฒะธั ะบะพะฝัะธะณ Xray
- Xray ะฟะตัะตะทะฐะฟัััะธััั ั ะฝะพะฒัะผ ะบะพะฝัะธะณะพะผ
- ะัะฟะพะปัะทัั ัะตััะธัะธะบะฐัั ะธะท `/etc/xray/certs/` (ะฒะฝัััะธ ะบะพะฝัะตะนะฝะตัะฐ)

---

## ๐ ะจะฐะณ 5: ะกะพะทะดะฐะฝะธะต ะฝะพะดั ะดะปั ะขััะบะผะตะฝะธััะฐะฝะฐ

### 5.1. ะ ะฟะฐะฝะตะปะธ ัะพะทะดะฐะนัะต ะฝะพะฒัั ะฝะพะดั (ะตัะปะธ ะฝัะถะฝะพ)

**Nodes โ Add Node:**

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Node Name: TM-Cloudflare-Node             โ
โ                                           โ
โ Address: cdn.myfly.space                  โ โ ะะฐั ะดะพะผะตะฝ ัะตัะตะท Cloudflare
โ Port: 2222                                โ โ ะะพัั ะดะปั ัะฒัะทะธ ั ะฟะฐะฝะตะปัั
โ                                           โ
โ Enable TLS: โ                             โ
โ Allow Insecure: โ                         โ
โ                                           โ
โ Inbound Tags:                             โ
โ   [TM-CDN-WS-IN]                          โ โ ะขะตะณ ะธะท ะบะพะฝัะธะณะฐ
โ                                           โ
โ [ Save ]                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 5.2. ะกะพะทะดะฐะนัะต ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะฐ ััะพะน ะฝะพะดะต

**Users โ Add User:**

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Username: tm_user1                        โ
โ                                           โ
โ Node: TM-Cloudflare-Node โผ                โ โ ะัะฑะตัะธัะต ะฝะพะดั
โ Inbound: TM-CDN-WS-IN โผ                   โ โ ะัะฑะตัะธัะต inbound
โ                                           โ
โ Traffic Limit: 50 GB                      โ
โ Expiry Date: 30 days                      โ
โ                                           โ
โ [ Create ]                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ะะฐะฝะตะปั ะฒะตัะฝะตั:**
```
vless://auto-generated-uuid@cdn.myfly.space:443?type=ws&path=/ws-path&security=tls#tm_user1
```

โ **ะะพัะพะฒะพ! ะะฐะทะดะฐะฒะฐะนัะต ัััะปะบั ะฟะพะปัะทะพะฒะฐัะตะปัะผ.**

---

## ๐ ะะดะธะฝ ัะตััะธัะธะบะฐั ะฝะฐ ะะกะ ะฝะพะดั

### ะัะตะธะผััะตััะฒะพ wildcard ัะตััะธัะธะบะฐัะฐ:

**ะฃ ะฒะฐั ะผะพะถะตั ะฑััั ะะะกะะะะฌะะ ะฝะพะด ั ะะะะะซะะ ััะฑะดะพะผะตะฝะฐะผะธ:**

```
ะะพะดะฐ 1 (ะขะ):    cdn.myfly.space      โ  ะขะพั ะถะต ัะตััะธัะธะบะฐั
ะะพะดะฐ 2 (ะขะ):    cdn2.myfly.space     โ  ะขะพั ะถะต ัะตััะธัะธะบะฐั
ะะพะดะฐ 3 (ะัะฐะฝ):  iran.myfly.space     โ  ะขะพั ะถะต ัะตััะธัะธะบะฐั
ะะพะดะฐ 4 (API):   api.myfly.space      โ  ะขะพั ะถะต ัะตััะธัะธะบะฐั
```

**ะัะต ะธัะฟะพะปัะทััั:**
- `/etc/xray/certs/cloudflare-origin.pem`
- `/etc/xray/certs/cloudflare-origin-key.pem`

**ะัะพััะพ ะผะตะฝัะตัะต `Host` ะฒ ะบะพะฝัะธะณะต:**

```json
// ะะพะดะฐ 1
"wsSettings": {
  "headers": {
    "Host": "cdn.myfly.space"
  }
}

// ะะพะดะฐ 2
"wsSettings": {
  "headers": {
    "Host": "cdn2.myfly.space"
  }
}
```

### ะะฐะทะฒะตัััะฒะฐะฝะธะต ะฝะพะฒะพะน ะฝะพะดั:

1. **ะกะพะทะดะฐะนัะต ะฝะพะฒัะน VPS**
2. **ะกะบะพะฟะธััะนัะต ะขะ ะะ ัะตััะธัะธะบะฐัั:**
   ```bash
   scp /etc/xray/certs/cloudflare-origin*.pem root@new-node:/etc/xray/certs/
   ```
3. **ะะฐะฟัััะธัะต Docker ั ัะตะผะธ ะถะต volumes**
4. **ะ ะฟะฐะฝะตะปะธ ัะพะทะดะฐะนัะต ะฝะพะฒัั ะฝะพะดั** ั ะฝะพะฒัะผ ััะฑะดะพะผะตะฝะพะผ
5. **ะะพัะพะฒะพ!** ะะพะฒะฐั ะฝะพะดะฐ ัะฐะฑะพัะฐะตั ั ัะตะผ ะถะต ัะตััะธัะธะบะฐัะพะผ

---

## ๐ ะกะพัััะตััะฒะพะฒะฐะฝะธะต Reality + WebSocket

### ะะฐ ะพะดะฝะพะน ะฝะพะดะต ะผะพะถะฝะพ ะธะผะตัั ะะะ:

**ะะพัั 443:** Reality (ะฟััะผะพะต ะฟะพะดะบะปััะตะฝะธะต, ะดะปั ััะฐะฑะธะปัะฝัั ัะตะณะธะพะฝะพะฒ)
**ะะพัั 8443:** WebSocket ัะตัะตะท Cloudflare (ะดะปั ะขััะบะผะตะฝะธััะฐะฝะฐ)

**docker-compose.yaml ะพััะฐะตััั ัะตะผ ะถะต!** (network_mode: host)

**ะะพะฝัะธะณ ะฒ ะฟะฐะฝะตะปะธ:**

```json
{
  "inbounds": [
    {
      "tag": "REALITY-MAIN",
      "port": 443,
      "protocol": "vless",
      "settings": {
        "clients": []
      },
      "streamSettings": {
        "network": "raw",
        "security": "reality",
        "realitySettings": {
          "target": "127.0.0.1:9443",
          "serverNames": ["gr-1.myfly.space"],
          "privateKey": "your-reality-key",
          "shortIds": ["864fe1a571be6d42"]
        }
      }
    },
    {
      "tag": "TM-CDN-WS-IN",
      "port": 8443,                                    // โ ะะะฃะะะ ะะะะข!
      "protocol": "vless",
      "settings": {
        "clients": []
      },
      "streamSettings": {
        "network": "ws",
        "security": "tls",
        "tlsSettings": {
          "certificates": [{
            "certificateFile": "/etc/xray/certs/cloudflare-origin.pem",
            "keyFile": "/etc/xray/certs/cloudflare-origin-key.pem"
          }]
        },
        "wsSettings": {
          "path": "/ws-path",
          "headers": {
            "Host": "cdn.myfly.space"
          }
        }
      }
    }
  ]
}
```

**Cloudflare Origin Rule:**
- Hostname: `cdn.myfly.space`
- Destination Port: `8443`

**ะะตะทัะปััะฐั:**
```
gr-1.myfly.space:443    โ Reality (ะฟััะผะพ)
cdn.myfly.space:443     โ Cloudflare โ 8443 โ WebSocket (ัะตัะตะท CDN)
```

---

## ๐ ะขะฐะฑะปะธัะฐ ะฟััะตะน

| ะะพะผะฟะพะฝะตะฝั | ะััั ะฝะฐ ัะพััะต | ะััั ะฒ ะบะพะฝัะตะนะฝะตัะต | ะ ะบะพะฝัะธะณะต ะธัะฟะพะปัะทัะตะผ |
|-----------|---------------|-------------------|---------------------|
| ะกะตััะธัะธะบะฐั (ะฟัะฑะปะธัะฝัะน) | `/etc/xray/certs/cloudflare-origin.pem` | `/etc/xray/certs/cloudflare-origin.pem` | `/etc/xray/certs/cloudflare-origin.pem` |
| ะะปัั (ะฟัะธะฒะฐัะฝัะน) | `/etc/xray/certs/cloudflare-origin-key.pem` | `/etc/xray/certs/cloudflare-origin-key.pem` | `/etc/xray/certs/cloudflare-origin-key.pem` |
| Xray ะฑะธะฝะฐัะฝะธะบ | `/var/lib/remnanode/xray` | `/usr/local/bin/xray` | - |
| GeoIP | `/var/lib/remnanode/geoip.dat` | `/usr/local/share/xray/geoip.dat` | - |

**ะัะฐะฒะธะปะพ:**
- ะ `docker-compose.yaml`: ัะบะฐะทัะฒะฐะตะผ ะฟััะธ ะฝะฐ ัะพััะต โ ะฟััะธ ะฒ ะบะพะฝัะตะนะฝะตัะต
- ะ `config.json` ะฟะฐะฝะตะปะธ: ัะบะฐะทัะฒะฐะตะผ ะฟััะธ **ะ ะะะะขะะะะะะ**

---

## ๐ Troubleshooting

### ะัะพะฑะปะตะผะฐ 1: Xray ะฝะต ะผะพะถะตั ะฟัะพัะธัะฐัั ัะตััะธัะธะบะฐัั

**ะกะธะผะฟัะพะผั:**
```
[Error] failed to load certificate
[Error] open /etc/xray/certs/cloudflare-origin.pem: no such file or directory
```

**ะัะธัะธะฝั:**
- Volume ะฝะต ะทะฐะผะฐะฟะฟะธัะพะฒะฐะฝ ะฒ docker-compose
- ะะตะฟัะฐะฒะธะปัะฝัะต ะฟััะธ ะฒ ะบะพะฝัะธะณะต
- ะคะฐะนะปั ะฝะต ัััะตััะฒััั ะฝะฐ ัะพััะต

**ะะตัะตะฝะธะต:**
```bash
# 1. ะัะพะฒะตัััะต ััะพ ัะฐะนะปั ะตััั ะะ ะฅะะกะขะ
ls -la /etc/xray/certs/

# 2. ะัะพะฒะตัััะต docker-compose.yaml
cat docker-compose.yaml | grep -A 10 volumes

# ะะพะปะถะฝะฐ ะฑััั ัััะพะบะฐ:
# - /etc/xray/certs:/etc/xray/certs:ro

# 3. ะะตัะตัะพะทะดะฐะนัะต ะบะพะฝัะตะนะฝะตั
docker-compose down && docker-compose up -d

# 4. ะัะพะฒะตัััะต ะฒ ะบะพะฝัะตะนะฝะตัะต
docker exec -it remnanode ls -la /etc/xray/certs/
```

---

### ะัะพะฑะปะตะผะฐ 2: Permission denied ะฟัะธ ััะตะฝะธะธ ะบะปััะฐ

**ะกะธะผะฟัะพะผั:**
```
[Error] failed to load private key
[Error] open /etc/xray/certs/cloudflare-origin-key.pem: permission denied
```

**ะัะธัะธะฝั:**
- ะะตะฟัะฐะฒะธะปัะฝัะต ะฟัะฐะฒะฐ ะดะพัััะฟะฐ ะฝะฐ ัะพััะต
- Xray ะฒ ะบะพะฝัะตะนะฝะตัะต ัะฐะฑะพัะฐะตั ะฟะพะด ะดััะณะธะผ ะฟะพะปัะทะพะฒะฐัะตะปะตะผ

**ะะตัะตะฝะธะต:**
```bash
# ะะฐ ัะพััะต
chmod 644 /etc/xray/certs/cloudflare-origin.pem
chmod 600 /etc/xray/certs/cloudflare-origin-key.pem

# ะะปะธ ัะดะตะปะฐะนัะต ะฒะปะฐะดะตะปััะตะผ root
chown root:root /etc/xray/certs/*.pem

# ะะตัะตะทะฐะฟัััะธัะต ะบะพะฝัะตะนะฝะตั
docker-compose restart
```

---

### ะัะพะฑะปะตะผะฐ 3: Cloudflare ะฒะพะทะฒัะฐัะฐะตั ะพัะธะฑะบั TLS

**ะกะธะผะฟัะพะผั:**
- ะะปะธะตะฝัั ะฝะต ะผะพะณัั ะฟะพะดะบะปััะธัััั
- ะัะธะฑะบะฐ SSL handshake
- Cloudflare error 525 (SSL handshake failed)

**ะัะธัะธะฝั:**
- SSL mode ะฒ Cloudflare ะฝะต Full (strict)
- ะะตะฟัะฐะฒะธะปัะฝัะน ัะตััะธัะธะบะฐั

**ะะตัะตะฝะธะต:**
```bash
# 1. ะ Cloudflare Dashboard
# SSL/TLS โ Overview
# Mode: Full (strict) โ

# 2. ะัะพะฒะตัััะต ัะตััะธัะธะบะฐั
openssl x509 -in /etc/xray/certs/cloudflare-origin.pem -noout -text

# ะะพะปะถะฝะพ ะฑััั:
# Subject: CN = *.myfly.space
# Validity: Not After : 2040+ ะณะพะด

# 3. ะขะตัั ะฟะพะดะบะปััะตะฝะธั
openssl s_client -connect cdn.myfly.space:443 -servername cdn.myfly.space

# ะะพะปะถะตะฝ ะฟะพะบะฐะทะฐัั ััะฟะตัะฝัะน handshake
```

---

### ะัะพะฑะปะตะผะฐ 4: ะะฐะฝะตะปั ะฝะต ะผะพะถะตั ะฟะพะดะบะปััะธัััั ะบ ะฝะพะดะต

**ะกะธะผะฟัะพะผั:**
- Node status: Offline ะฒ ะฟะฐะฝะตะปะธ
- ะะต ะฟะตัะตะดะฐะตััั ะบะพะฝัะธะณ

**ะัะธัะธะฝั:**
- ะะพัั 2222 ะทะฐะบััั firewall
- API ะฝะพะดั ะฝะต ะทะฐะฟััะตะฝ
- ะะตะฟัะฐะฒะธะปัะฝัะน ะฐะดัะตั ะฒ ะฝะฐัััะพะนะบะฐั ะฝะพะดั

**ะะตัะตะฝะธะต:**
```bash
# 1. ะัะพะฒะตัััะต ััะพ ะฟะพัั 2222 ะพัะบััั
ufw allow 2222/tcp

# 2. ะัะพะฒะตัััะต ััะพ API ะฝะพะดั ัะปััะฐะตั
netstat -tlnp | grep 2222

# 3. ะัะพะฒะตัััะต ะปะพะณะธ ะฝะพะดั
docker logs remnanode | grep -i api

# 4. ะ ะฟะฐะฝะตะปะธ ะฟัะพะฒะตัััะต ะฐะดัะตั ะฝะพะดั:
# Nodes โ Edit โ Address ะดะพะปะถะตะฝ ะฑััั ะฟัะฐะฒะธะปัะฝัะผ IP/ะดะพะผะตะฝะพะผ
```

---

## โ Checklist ะฝะฐัััะพะนะบะธ

**ะะพะปััะตะฝะธะต ัะตััะธัะธะบะฐัะฐ:**
- [ ] ะกะพะทะดะฐะฝ Cloudflare Origin Certificate
- [ ] ะฃะบะฐะทะฐะฝ wildcard: `*.myfly.space`
- [ ] ะกัะพะบ: 15 years
- [ ] ะกะบะพะฟะธัะพะฒะฐะฝั ะพะฑะฐ ะฑะปะพะบะฐ (cert + key)

**ะฃััะฐะฝะพะฒะบะฐ ะฝะฐ ัะพัั:**
- [ ] ะกะพะทะดะฐะฝะฐ ะดะธัะตะบัะพัะธั: `/etc/xray/certs/`
- [ ] ะกะพััะฐะฝะตะฝ ัะตััะธัะธะบะฐั: `cloudflare-origin.pem`
- [ ] ะกะพััะฐะฝะตะฝ ะบะปัั: `cloudflare-origin-key.pem`
- [ ] ะฃััะฐะฝะพะฒะปะตะฝั ะฟัะฐะฒะฐ: `chmod 644/600`

**Docker:**
- [ ] ะะฑะฝะพะฒะปะตะฝ `docker-compose.yaml`
- [ ] ะะพะฑะฐะฒะปะตะฝ volume: `/etc/xray/certs:/etc/xray/certs:ro`
- [ ] ะะพะฝัะตะนะฝะตั ะฟะตัะตัะพะทะดะฐะฝ: `docker-compose up -d`
- [ ] ะกะตััะธัะธะบะฐัั ะฒะธะดะฝั ะฒ ะบะพะฝัะตะนะฝะตัะต: `docker exec -it remnanode ls /etc/xray/certs/`

**ะะพะฝัะธะณ ะฟะฐะฝะตะปะธ:**
- [ ] ะะพะฑะฐะฒะปะตะฝ WebSocket inbound
- [ ] Tag ัะบะฐะทะฐะฝ: `TM-CDN-WS-IN`
- [ ] ะััะธ ะบ ัะตััะธัะธะบะฐัะฐะผ: `/etc/xray/certs/cloudflare-origin*.pem`
- [ ] Host ัะบะฐะทะฐะฝ: ะฒะฐั ะดะพะผะตะฝ ัะตัะตะท Cloudflare
- [ ] Save & Restart ะฒัะฟะพะปะฝะตะฝ

**Cloudflare:**
- [ ] DNS: A ะทะฐะฟะธัั ะดะปั `cdn.myfly.space` โ IP ัะตัะฒะตัะฐ
- [ ] Proxy: ON (ะพัะฐะฝะถะตะฒะพะต ะพะฑะปะฐะบะพ) ๐
- [ ] SSL/TLS Mode: Full (strict)
- [ ] Network โ WebSockets: ON
- [ ] Origin Rule ัะพะทะดะฐะฝ (ะตัะปะธ ะฟะพัั != 443)

**ะขะตััะธัะพะฒะฐะฝะธะต:**
- [ ] ะกะพะทะดะฐะฝ ัะตััะพะฒัะน ะฟะพะปัะทะพะฒะฐัะตะปั ัะตัะตะท ะฟะฐะฝะตะปั
- [ ] ะฃะบะฐะทะฐะฝ inbound: `TM-CDN-WS-IN`
- [ ] ะะพะปััะตะฝะฐ vless:// ัััะปะบะฐ
- [ ] ะะพะดะบะปััะตะฝะธะต ััะฟะตัะฝะพ
- [ ] ะะพะณะธ ะฟะพะบะฐะทัะฒะฐัั ะฐะบัะธะฒะฝะพััั: `docker logs remnanode -f`

---

## ๐ฏ ะัะพะณะพะฒะฐั ััะตะผะฐ

```
Cloudflare Origin Certificate (wildcard)
           โ
    /etc/xray/certs/  (ะฅะะกะข)
           โ
    Volume mapping ะฒ docker-compose
           โ
    /etc/xray/certs/  (ะะะะขะะะะะ)
           โ
    Xray ัะธัะฐะตั ะธะท /etc/xray/certs/
           โ
    ะะฐะฑะพัะฐะตั ะดะปั ะะกะะฅ ััะฑะดะพะผะตะฝะพะฒ!

    cdn.myfly.space   โ
    cdn2.myfly.space  โ
    api.myfly.space   โ
    iran.myfly.space  โ
```

**ะะดะธะฝ ัะตััะธัะธะบะฐั - ะฑะตัะบะพะฝะตัะฝะพะต ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธะต!** ๐

---

**ะะฐัะฐ ัะพะทะดะฐะฝะธั:** 2025-11-10
